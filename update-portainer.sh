#!/bin/bash

# Clear the screen
clear

# Display ASCII art banner
echo "────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────"
echo "─██████████████─██████████████─████████████████───██████████████─██████████████─██████████─██████──────────██████─██████████████─████████████████───"
echo "─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░░░██───██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░██─██░░██████████──██░░██─██░░░░░░░░░░██─██░░░░░░░░░░░░██───"
echo "─██░░██████░░██─██░░██████░░██─██░░████████░░██───██████░░██████─██░░██████░░██─████░░████─██░░░░░░░░░░██──██░░██─██░░██████████─██░░████████░░██───"
echo "─██░░██──██░░██─██░░██──██░░██─██░░██────██░░██───────██░░██─────██░░██──██░░██───██░░██───██░░██████░░██──██░░██─██░░██─────────██░░██────██░░██───"
echo "─██░░██████░░██─██░░██──██░░██─██░░████████░░██───────██░░██─────██░░██████░░██───██░░██───██░░██──██░░██──██░░██─██░░██████████─██░░████████░░██───"
echo "─██░░░░░░░░░░██─██░░██──██░░██─██░░░░░░░░░░░░██───────██░░██─────██░░░░░░░░░░██───██░░██───██░░██──██░░██──██░░██─██░░░░░░░░░░██─██░░░░░░░░░░░░██───"
echo "─██░░██████████─██░░██──██░░██─██░░██████░░████───────██░░██─────██░░██████░░██───██░░██───██░░██──██░░██──██░░██─██░░██████████─██░░██████░░████───"
echo "─██░░██─────────██░░██──██░░██─██░░██──██░░██─────────██░░██─────██░░██──██░░██───██░░██───██░░██──██░░██████░░██─██░░██─────────██░░██──██░░██─────"
echo "─██░░██─────────██░░██████░░██─██░░██──██░░██████─────██░░██─────██░░██──██░░██─████░░████─██░░██──██░░░░░░░░░░██─██░░██████████─██░░██──██░░██████─"
echo "─██░░██─────────██░░░░░░░░░░██─██░░██──██░░░░░░██─────██░░██─────██░░██──██░░██─██░░░░░░██─██░░██──██████████░░██─██░░░░░░░░░░██─██░░██──██░░░░░░██─"
echo "─██████─────────██████████████─██████──██████████─────██████─────██████──██████─██████████─██████──────────██████─██████████████─██████──██████████─"
echo "────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────"
echo "──────────────────────────────────────────────────────────────────────────────────────────────────────────────"
echo "─██████──██████─██████████████─████████████───██████████████─██████████████─██████████████─████████████████───"
echo "─██░░██──██░░██─██░░░░░░░░░░██─██░░░░░░░░████─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░░░██───"
echo "─██░░██──██░░██─██░░██████░░██─██░░████░░░░██─██░░██████░░██─██████░░██████─██░░██████████─██░░████████░░██───"
echo "─██░░██──██░░██─██░░██──██░░██─██░░██──██░░██─██░░██──██░░██─────██░░██─────██░░██─────────██░░██────██░░██───"
echo "─██░░██──██░░██─██░░██████░░██─██░░██──██░░██─██░░██████░░██─────██░░██─────██░░██████████─██░░████████░░██───"
echo "─██░░██──██░░██─██░░░░░░░░░░██─██░░██──██░░██─██░░░░░░░░░░██─────██░░██─────██░░░░░░░░░░██─██░░░░░░░░░░░░██───"
echo "─██░░██──██░░██─██░░██████████─██░░██──██░░██─██░░██████░░██─────██░░██─────██░░██████████─██░░██████░░████───"
echo "─██░░██──██░░██─██░░██─────────██░░██──██░░██─██░░██──██░░██─────██░░██─────██░░██─────────██░░██──██░░██─────"
echo "─██░░██████░░██─██░░██─────────██░░████░░░░██─██░░██──██░░██─────██░░██─────██░░██████████─██░░██──██░░██████─"
echo "─██░░░░░░░░░░██─██░░██─────────██░░░░░░░░████─██░░██──██░░██─────██░░██─────██░░░░░░░░░░██─██░░██──██░░░░░░██─"
echo "─██████████████─██████─────────████████████───██████──██████─────██████─────██████████████─██████──██████████─"
echo "──────────────────────────────────────────────────────────────────────────────────────────────────────────────"

# Check for root privileges
if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root" 
   exit 1
fi

# Stop all Docker containers
echo "Stopping all Docker containers..."
docker ps -a -q | xargs -r docker stop -t 30

# Check if any containers are still running
while true; do
    if [ -z "$(docker ps -q)" ]; then
        echo "All Docker containers have been stopped."
        break
    else
        echo "Waiting for containers to stop..."
        sleep 5
    fi
done

# Remove the Portainer container if it exists
if docker ps -a | grep -q portainer; then
    echo "Removing Portainer container..."
    docker rm portainer || { echo "Failed to remove the Portainer container. Exiting script."; exit 1; }
fi

# Verify that the Portainer container has been removed
if docker ps -a | grep -q portainer; then
    echo "Failed to remove the Portainer container. Exiting script."
    exit 1
else
    echo "Portainer container successfully removed."
fi

# Find the image used by the Portainer container
portainer_image=$(docker inspect portainer --format='{{.Config.Image}}')

if [ -n "$portainer_image" ]; then
    echo "Portainer container image: $portainer_image"

    # Prompt for confirmation to delete the image
    read -p "Are you sure you want to delete this image? [y/N] " confirm
    if [[ $confirm =~ ^[Yy]$ ]]; then
        echo "Deleting image: $portainer_image"
        docker rmi "$portainer_image"
    else
        echo "Image deletion cancelled."
    fi
else
    echo "No Portainer container image found."
fi

# Pull and run the latest Portainer container
echo "Now installing the updated Portainer image..."
docker run -d -p 8000:8000 -p 9000:9000 -p 9443:9443 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v /opt/portainer/portainer_container:/data portainer/portainer-ce:latest \
&& echo "Update process completed." \
|| echo "Failed to run Portainer container."
